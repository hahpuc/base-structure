<div class="flex items-stretch grow shrink-0 justify-center mb-5" id="sidebar_menu">
  <div
    class="kt-scrollable-y-auto grow"
    data-kt-scrollable="true"
    data-kt-scrollable-dependencies="#sidebar_header, #sidebar_footer"
    data-kt-scrollable-height="auto"
    data-kt-scrollable-offset="0px"
    data-kt-scrollable-wrappers="#sidebar_menu"
  >
    <!-- Primary Menu -->
    <div class="mb-5">
      <h3 class="text-sm text-muted-foreground uppercase ps-5 inline-block mb-3">Pages</h3>
      <div
        class="kt-menu flex flex-col w-full gap-1.5 px-3.5"
        data-kt-menu="true"
        data-kt-menu-accordion-expand-all="false"
        id="sidebar_primary_menu"
      >
        <!-- Loop through filtered menu items based on permissions -->
        @for (item of filteredMenuItems; track item) {
          <ng-container *ngTemplateOutlet="menuItemTemplate; context: { $implicit: item, level: 0 }"></ng-container>
        }
      </div>
    </div>
    <!-- End of Primary Menu -->
  </div>
</div>

<!-- Menu Item Template -->
<ng-template #menuItemTemplate let-item let-level="level">
  <!-- Simple Menu Item (No Children) -->
  @if (!item.isAccordion && item.path) {
    <div class="kt-menu-item" [class.active]="isActiveRoute(item.path || '')">
      <a
        class="kt-menu-link gap-2.5 py-2 px-2.5 rounded-md kt-menu-item-active:bg-accent/60 kt-menu-link-hover:bg-accent/60 !menu-item-here:bg-transparent"
        [routerLink]="item.path"
      >
        @if (level === 0 && item.icon) {
          <span
            class="kt-menu-icon items-start text-lg text-secondary-foreground kt-menu-item-active:text-mono kt-menu-item-here:text-mono"
          >
            <i [class]="'ki-filled ' + item.icon"></i>
          </span>
        }
        <span
          class="kt-menu-title text-sm text-secondary-foreground font-medium kt-menu-item-here:text-mono kt-menu-item-active:text-mono kt-menu-link-hover:text-mono"
        >
          {{ item.label | translate }}
        </span>
      </a>
    </div>
  }

  <!-- Accordion Menu Item (Has Children) -->
  @if (item.isAccordion && item.children) {
    <div
      class="kt-menu-item"
      [class.here]="isParentActive(item)"
      [class.show]="isParentActive(item)"
      data-kt-menu-item-toggle="accordion"
      data-kt-menu-item-trigger="click"
    >
      <!-- Accordion Header -->
      <div
        class="kt-menu-link py-2 px-2.5 rounded-md border border-transparent !menu-item-here:bg-transparent"
        [class.gap-2.5]="level === 0"
        [class.kt-menu-item-hover:bg-transparent]="level === 0"
        [class.kt-menu-item-here:bg-transparent]="level === 0"
      >
        @if (level === 0 && item.icon) {
          <span
            class="kt-menu-icon items-start text-muted-foreground text-lg kt-menu-item-here:text-mono kt-menu-item-show:text-mono kt-menu-link-hover:text-mono"
          >
            <i [class]="'ki-filled ' + item.icon"></i>
          </span>
        }
        <span
          class="kt-menu-title text-sm text-secondary-foreground kt-menu-item-here:text-mono kt-menu-item-show:text-mono kt-menu-link-hover:text-mono"
          [class.font-medium]="level === 0"
        >
          {{ item.label | translate }}
        </span>
        <span
          class="kt-menu-arrow text-muted-foreground kt-menu-item-here:text-muted-foreground kt-menu-item-show:text-foreground kt-menu-link-hover:text-foreground"
        >
          <span class="inline-flex kt-menu-item-show:hidden">
            <i class="ki-filled ki-down text-xs"></i>
          </span>
          <span class="hidden kt-menu-item-show:inline-flex">
            <i class="ki-filled ki-up text-xs"></i>
          </span>
        </span>
      </div>

      <!-- Accordion Content with dynamic template -->
      <div class="kt-menu-accordion gap-px" [class.ps-7]="level === 0" [class.ps-2.5]="level > 0">
        @for (childItem of item.children; track childItem) {
          <ng-container
            *ngTemplateOutlet="menuItemTemplate; context: { $implicit: childItem, level: level + 1 }"
          ></ng-container>
        }
      </div>
    </div>
  }
</ng-template>
